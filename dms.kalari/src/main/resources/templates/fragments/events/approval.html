<div class="container-fluid">
	<div class="modal-header">
		<h5 class="modal-title" th:text="${pageTitle}">Certificate
			Approval</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal"
			aria-label="Close"></button>
	</div>

	<div class="modal-body">
		<!-- Filter Section -->
		<div class="card shadow-sm border-0 mb-4 no-print" id="filter_section">
			<form id="search-form" method="GET"
				th:action="@{/champ_certificate_approve/{eventId}(eventId=${eventId})}">
				<div class="row g-1 align-items-end">
					<div class="col-12 col-md-4">
						<label class="form-label">Item</label> <select name="itemId"
							class="form-select">
							<option value="">-- Select Item --</option>
							<option th:each="entry : ${itemsMap}" th:value="${entry.key}"
								th:text="${entry.value}"
								th:selected="${paramx['itemId']} == ${entry.key.toString()}"></option>
						</select>
					</div>
					<div class="col-12 col-md-4">
						<label class="form-label">Gender</label> <select name="gender"
							class="form-select">
							<option value="">-- Select Gender --</option>
							<option th:each="g : ${genders}" th:value="${g}" th:text="${g}"
								th:selected="${paramx['gender']} == ${g.name()}"></option>
						</select>
					</div>
					<div class="col-12 col-md-4">
						<label class="form-label">Category</label> <select name="category"
							class="form-select">
							<option value="">-- Select Category --</option>
							<option th:each="c : ${categories}" th:value="${c}"
								th:text="${c}"
								th:selected="${paramx['category']} == ${c.name()}"></option>
						</select>
					</div>
				</div>
			</form>
		</div>

		<!-- Approval List -->
		<form
			th:action="@{/champ_certificate_approve/{eventId}(eventId=${eventId})}"
			method="post" id="certificateApprovalForm">
			<input type="hidden" th:name="${_csrf.parameterName}"
				th:value="${_csrf.token}" />
		    <input type="hidden" name="cparams" th:value="${combinedParam}" />
				

			<div th:if="${matrix == null or #maps.isEmpty(matrix)}">
				<div class="alert alert-info">No participants found.</div>
			</div>

			<div th:each="itemEntry : ${matrix}">
				<div class="item-heading">
					<i class="fas fa-award me-2"></i>Item: <span
						th:text="${itemEntry.key}"></span>
				</div>

				<div th:each="genderEntry : ${itemEntry.value}">
					<div class="gender-heading" th:text="${genderEntry.key}"></div>

					<div th:each="catEntry : ${genderEntry.value}"
						class="category-section">
						<div class="category-heading">
							<i class="fas fa-tag me-2"></i>Category: <span
								th:text="${catEntry.key}"></span>
						</div>

						<div th:each="mei : ${catEntry.value}" class="participant-card">
							<div class="row g-3 align-items-center">

								<!-- Participant Name -->
								<div class="col-md-3">
									<label class="form-label">Participant</label>
									<div class="fw-bold text-primary"
										th:text="${mei.memberEventMember.userFname}"></div>
								</div>

								<!-- Kalari -->
								<div class="col-md-3">
									<label class="form-label">Kalari</label>
									<div th:text="${mei.memberEventNode.nodeName}"></div>
								</div>

								<!-- Score -->
								<div class="col-md-2 text-center">
									<label class="form-label">Score</label>
									<div class="fw-semibold"
										th:text="${mei.memberEventScore != null ? mei.memberEventScore : '-'}"></div>
								</div>

								<!-- Grade -->
								<div class="col-md-2 text-center">
									<label class="form-label">Grade</label>
									<div class="fw-semibold text-success"
										th:text="${mei.memberEventGrade != null ? mei.memberEventGrade.name() : '-'}"></div>
								</div>

								<div class="col-md-2 text-center">
								    <label class="form-label d-block">Approve</label>
								    <input type="checkbox"
								           class="form-check-input custom-approve-checkbox"
								           th:name="${'approved[' + mei.meiId + ']'}"
								           th:checked="${mei.verificationStatus?.name() == 'APPROVED'}"
								           th:disabled="${mei.certificateStatus?.name() == 'GENERATED'}" />
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
			<div id="error-messages" class="text-danger mt-2"></div>
		</form>
	</div>

	<div class="modal-footer">
		<button type="button" class="btn btn-secondary"
			data-bs-dismiss="modal">Close</button>
		<button type="button" class="btn btn-primary"
			onclick="submitHtmlForm('certificateApprovalForm')">Verify
			and Approve</button>
	</div>
</div>


<script>
	function searchRequest(formId) {
		var form = $('#' + formId); // jQuery form object
		var url = form.attr('action'); // action with eventId/nodeId

		// get selected values
		var itemVal = form.find('select[name="itemId"]').val();
		var genderVal = form.find('select[name="gender"]').val();
		var categoryVal = form.find('select[name="category"]').val();

		console.log("Item:", itemVal, "Gender:", genderVal, "Category:",
				categoryVal);

		// validate: all must be non-empty
		if (itemVal && genderVal && categoryVal) {
			loadContent(url, 'modal2', form);
		}
	}

	$(document).ready(function() {
		// call searchRequest whenever any select changes
		$('#search-form select').on('change', function() {
			searchRequest('search-form');
		});

		// optional: call it once on page load if selects have values
		// searchRequest('search-form');
	});
</script>

<style>
.custom-approve-checkbox {
	width: 28px;
	height: 28px;
	cursor: pointer;
	appearance: none;
	-webkit-appearance: none;
	border: 3px solid #dc3545; /* Bootstrap red */
	border-radius: 6px;
	background-color: white;
	position: relative;
	transition: all 0.25s ease-in-out;
}

.custom-approve-checkbox:hover {
	box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}

.custom-approve-checkbox:checked {
	background-color: #198754; /* Bootstrap green */
	border-color: #198754;
	box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
}

.custom-approve-checkbox:checked::after {
	content: 'âœ”';
	color: white;
	font-weight: bold;
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-55%, -44%);
	font-size: 16px;
}


.custom-approve-checkbox:disabled {
    cursor: not-allowed;
    opacity: 0.6;      /* slightly faded */
    border-radius: 18px;
}
</style>
