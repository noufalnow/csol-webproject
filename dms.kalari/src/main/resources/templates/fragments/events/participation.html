<div class="container-fluid">
	<!-- Modal Header -->
	<div class="modal-header">
		<h5 class="modal-title" id="addEventModalLabel" th:text="${pageTitle}">Add
			New Event</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal"
			aria-label="Close"></button>
	</div>


	<div class="modal-body">


		<!-- Single form wrapping everything -->



		<div class="row">
			<!-- Left: Item Tabs - Show unique items -->
			<div class="col-3">
				<ul class="nav flex-column nav-pills me-3" id="eventTabs"
					role="tablist">
					<li class="nav-item"
						th:each="uniqueItem, iterStat : ${uniqueEventItems}">
						<button class="nav-link text-truncate d-block" type="button"
							th:classappend="${iterStat.index == 0} ? ' active'"
							th:id="'tab_' + ${uniqueItem.evitemId}" data-bs-toggle="pill"
							th:data-bs-target="'#content_' + ${uniqueItem.evitemId}"
							th:title="${uniqueItem.evitemName}">
							<span th:text="${uniqueItem.evitemName}"></span>
						</button>
					</li>
				</ul>
			</div>

			<!-- Right: Tab Content -->
			<div class="col-9 tab-content">

				<div class="tab-pane fade"
					th:each="uniqueItem, iterStat : ${uniqueEventItems}"
					th:classappend="${iterStat.index == 0} ? ' show active'"
					th:id="'content_' + ${uniqueItem.evitemId}" role="tabpanel"
					th:aria-labelledby="'tab_' + ${uniqueItem.evitemId}">
					<form
						th:action="@{/champ_participation/{eventId}/{nodeId}(eventId=${eventId}, nodeId=${nodeId})}"
						method="post"
						th:id="'participationForm_' + ${uniqueItem.evitemId}">
						<input type="hidden" th:name="${_csrf.parameterName}"
							th:value="${_csrf.token}" />
							
					    <input type="hidden" name = "itemId"  th:value="${uniqueItem.evitemId}">		

						<table class="table table-bordered matrix-table text-center">
							<thead class="table-light">
								<tr>
									<th style="width: 15%">Category</th>
									<th>Boys</th>
									<th>Girls</th>
								</tr>
							</thead>
							<tbody>
								<th:block th:if="${itemCategoryMap[uniqueItem.evitemId]}">
									<th:block
										th:each="catEntry : ${itemCategoryMap[uniqueItem.evitemId].entrySet()}">
										<th:block th:each="itemInCategory : ${catEntry.value}">
											<tr>
												<td th:text="${catEntry.key}"></td>
												<!-- Boys -->
												<td class="boys-cell">
													<div th:each="user : ${memberMatrix[catEntry.key].MALE}"
														class="form-check">
														<input class="form-check-input" type="checkbox"
															th:id="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_b'"
															th:name="'selectedUsers[' + ${user.userId} + '][' + ${catEntry.key} + '][MALE]'"
															th:value="${itemInCategory.eimId}"
															th:checked="${selectedKeys.contains(itemInCategory.eimId + '-' + user.userId)}" />
														<label class="form-check-label"
															th:for="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_b'"
															th:text="${user.userFname + ' ' + user.userLname}"></label>
													</div>
												</td>

												<!-- Girls -->
												<td class="girls-cell">
													<div th:each="user : ${memberMatrix[catEntry.key].FEMALE}"
														class="form-check">
														<input class="form-check-input" type="checkbox"
															th:id="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_g'"
															th:name="'selectedUsers[' + ${user.userId} + '][' + ${catEntry.key} + '][FEMALE]'"
															th:value="${itemInCategory.eimId}"
															th:checked="${selectedKeys.contains(itemInCategory.eimId + '-' + user.userId)}" />
														<label class="form-check-label"
															th:for="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_g'"
															th:text="${user.userFname + ' ' + user.userLname}"></label>
													</div>
												</td>
											</tr>
										</th:block>
									</th:block>
								</th:block>



							</tbody>

						</table>


						<div class="text-end mt-3">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Cancel</button>
							<button type="button" class="btn btn-primary"
								th:onclick="'validateAndSubmit(\'participationForm_' + ${uniqueItem.evitemId} + '\')'">
								Save Selections</button>
						</div>
					</form>

				</div>



			</div>
		</div>
		<div id="error-messages" class="text-danger mt-2"></div>



	</div>




	<!-- Modal Footer -->
	<div class="modal-footer"></div>
	<dialog id="limitDialog">
	<p>You can select a maximum of 3 users in this section.</p>
	<button id="closeDialog">OK</button>
	</dialog>
</div>
<style>
/* Form and Modal Styles */
form {
	max-width: 100%;
}

.modal-dialog {
	max-width: 99% !important;
}

@media ( max-width : 768px) {
	.modal-dialog {
		max-width: 100% !important;
		margin: 10px;
	}
}

.modal-body {
	max-height: 70vh;
	overflow-y: auto;
}

/* Table Styles */
.matrix-table th, .matrix-table td {
	text-align: left; /* Align text to left */
	vertical-align: middle; /* Vertically center content */
}

.matrix-table .form-check {
	margin-bottom: 0.3rem; /* Spacing between checkboxes */
}

/* Tabs Styles */
#eventTabs {
	max-height: 70vh;
	overflow-y: auto;
}

.nav-pills .nav-link {
	white-space: nowrap; /* Prevent text wrapping in tabs */
}
</style>

<script>
	function validateAndSubmit(formId) {
		submitHtmlForm(formId, '#events_target');
	}
</script>



<script>

var dialog = document.getElementById('limitDialog');
var closeBtn = document.getElementById('closeDialog');

closeBtn.addEventListener('click', () => {
    dialog.close();
});

document.addEventListener('change', function (e) {
    if (e.target && e.target.matches('td.boys-cell input[type="checkbox"], td.girls-cell input[type="checkbox"]')) {
    	var cell = e.target.closest('td.boys-cell, td.girls-cell');
        if (!cell) return;

        var checkboxes = Array.from(cell.querySelectorAll('input[type="checkbox"]'));
        var checkedCount = checkboxes.filter(c => c.checked).length;

        if (checkedCount > 3) {
            e.target.checked = false;
            dialog.showModal();  // Show the dialog instead of alert
        }
    }
});


</script>
