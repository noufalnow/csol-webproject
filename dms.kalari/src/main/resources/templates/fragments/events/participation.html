<div class="container-fluid">
	<!-- Modal Header -->
	<div class="modal-header">
		<h5 class="modal-title" id="addEventModalLabel" th:text="${pageTitle}">Add
			New Event</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal"
			aria-label="Close"></button>
	</div>


	<div class="modal-body">


		<!-- Single form wrapping everything -->



		<div class="row flex-column flex-lg-row">
			<!-- Tabs -->
			<div class="col-12 col-lg-3 mb-2 mb-lg-0">
				<ul class="nav nav-pills flex-column overflow-auto w-100"
					id="eventTabs" role="tablist">
					<li class="nav-item w-100"
						th:each="uniqueItem, iterStat : ${uniqueEventItems}">
						<button class="nav-link border text-truncate w-100" type="button"
							th:classappend="${iterStat.index == 0} ? ' active'"
							th:id="'tab_' + ${uniqueItem.evitemId}" data-bs-toggle="pill"
							th:data-bs-target="'#content_' + ${uniqueItem.evitemId}"
							th:title="${uniqueItem.evitemName}">
							<span th:text="${uniqueItem.evitemName}"></span>
						</button>
					</li>
				</ul>

			</div>

			<!-- Tab Content -->
			<div class="col-12 col-lg-9 tab-content">
				<div class="tab-pane fade"
					th:each="uniqueItem, iterStat : ${uniqueEventItems}"
					th:classappend="${iterStat.index == 0} ? ' show active'"
					th:id="'content_' + ${uniqueItem.evitemId}" role="tabpanel"
					th:aria-labelledby="'tab_' + ${uniqueItem.evitemId}">

					<form
						th:action="@{/champ_participation/{eventId}/{nodeId}(eventId=${eventId}, nodeId=${nodeId})}"
						method="post"
						th:id="'participationForm_' + ${uniqueItem.evitemId}">

						<input type="hidden" th:name="${_csrf.parameterName}"
							th:value="${_csrf.token}" /> <input type="hidden" name="itemId"
							th:value="${uniqueItem.evitemId}" />

						<!-- Responsive Grid -->
						<div th:if="${itemCategoryMap[uniqueItem.evitemId]}">
							<!-- Category grouping (replace your current category block with this) -->
							<div
								th:each="catEntry : ${itemCategoryMap[uniqueItem.evitemId].entrySet()}"
								class="p-3 mb-3 border rounded bg-white shadow-sm">

								<!-- Category Title -->
								<h6 class="fw-bold mb-3" th:text="${catEntry.key}"
									style="border-bottom: 1px solid #dee2e6; padding-bottom: 5px;"></h6>

								<!-- For each item inside this category (restore itemInCategory loop) -->
								<div th:each="itemInCategory : ${catEntry.value}"
									class="mb-2 p-2 border rounded">
									<div
										class="d-flex flex-column flex-sm-row align-items-start gap-3">


										<!-- Boys / Girls columns -->
										<div class="w-100 row g-2">
											<!-- Boys -->
											<div class="col-12 col-sm-6">
												<div class="p-2 border rounded bg-light h-100">
													<div class="fw-semibold text-primary mb-2">
														<i class="fa-solid fa-person text-primary me-1"></i> Boys
													</div>

													<!-- iterate users (same as original) -->
													<div th:each="user : ${memberMatrix[catEntry.key].MALE}"
														class="form-check">
														<input class="form-check-input" type="checkbox"
															th:id="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_b'"
															th:name="'selectedUsers[' + ${user.userId} + '][' + ${catEntry.key} + '][MALE]'"
															th:value="${itemInCategory.eimId}"
															th:checked="${selectedKeys != null and selectedKeys.contains(itemInCategory.eimId + '-' + user.userId)}" />
														<label class="form-check-label"
															th:for="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_b'"
															th:text="${user.userFname + ' ' + user.userLname}"></label>
													</div>
												</div>
											</div>

											<!-- Girls -->
											<div class="col-12 col-sm-6">
												<div class="p-2 border rounded bg-light h-100">
													<div class="fw-semibold text-danger mb-2">
														<i class="fa-solid fa-person-dress text-danger me-1"></i>
														Girls
													</div>

													<!-- iterate users (same as original) -->
													<div th:each="user : ${memberMatrix[catEntry.key].FEMALE}"
														class="form-check">
														<input class="form-check-input" type="checkbox"
															th:id="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_g'"
															th:name="'selectedUsers[' + ${user.userId} + '][' + ${catEntry.key} + '][FEMALE]'"
															th:value="${itemInCategory.eimId}"
															th:checked="${selectedKeys != null and selectedKeys.contains(itemInCategory.eimId + '-' + user.userId)}" />
														<label class="form-check-label"
															th:for="'chk_' + ${itemInCategory.eimId} + '_' + ${catEntry.key} + '_' + ${user.userId} + '_g'"
															th:text="${user.userFname + ' ' + user.userLname}"></label>
													</div>
												</div>
											</div>

										</div>
									</div>
									<!-- end item flex -->
								</div>
								<!-- end itemInCategory loop -->
							</div>
							<!-- end category -->


						</div>

						<!-- Buttons -->
						<div class="text-end mt-3">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Cancel</button>
							<button type="button" class="btn btn-primary"
								th:onclick="'validateAndSubmit(\'participationForm_' + ${uniqueItem.evitemId} + '\')'">
								Save Selections</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="error-messages" class="text-danger mt-2"></div>



	</div>




	<!-- Modal Footer -->
	<div class="modal-footer"></div>
	<dialog id="limitDialog">
	<p>You can select a maximum of 3 users in this section.</p>
	<button id="closeDialog">OK</button>
	</dialog>
</div>


<style>
/* Modal and Form Styles */
.modal-dialog {
	max-width: 95% !important;
	margin: 10px auto;
}

.modal-body {
	padding: 0.5rem 1rem;
}

form {
	width: 100%;
	padding: 4px;
}

/* Tabs Styles */
#eventTabs {
	max-height: 70vh;
	overflow-y: auto;
}

.nav-pills .nav-link {
	white-space: nowrap;
	text-overflow: ellipsis;
	overflow: hidden;
	font-size: 0.9rem;
	margin-bottom: 0.2rem;
}

/* Table Styles */
.matrix-table th, .matrix-table td {
	text-align: left;
	vertical-align: middle;
	font-size: 0.85rem;
}

.matrix-table .form-check {
	margin-bottom: 0.2rem;
}

/* Responsive adjustments */
@media ( max-width : 992px) {
	.row {
		flex-direction: column;
	}
	.col-3, .col-9 {
		flex: 0 0 100%;
		max-width: 100%;
	}

	/* Tabs on top for small screens */
	#eventTabs {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		overflow-x: auto;
		margin-bottom: 1rem;
	}
	#eventTabs .nav-link {
		flex: 0 0 auto;
		margin-right: 0.3rem;
	}

	/* Table scroll horizontally if needed */
	.matrix-table {
		display: block;
		width: 100%;
		overflow-x: auto;
	}
	.matrix-table th, .matrix-table td {
		white-space: nowrap;
	}
}

/* Optional: smaller modal for very small screens */
@media ( max-width : 576px) {
	.modal-body {
		max-height: 60vh;
		padding: 0.25rem 0.5rem;
	}
	.nav-link {
		font-size: 0.8rem;
		padding: 0.25rem 0.5rem;
	}
	.matrix-table th, .matrix-table td {
		font-size: 0.75rem;
		padding: 0.25rem 0.5rem;
	}
	.text-end button {
		padding: 0.25rem 0.5rem;
		font-size: 0.8rem;
	}
}

form-check-label {
  font-size: 1.2rem;
}

.modal-body {
  max-height: 100%;
}

</style>



<script>
	function validateAndSubmit(formId) {
		submitHtmlForm(formId, '#events_target');
	}
	
	document.addEventListener("shown.bs.modal", function () {
		  let modal = document.querySelector("#dynamicModal .modal-content");
		  modal.style.height = window.innerHeight + "px";
		});

</script>



<script>

var dialog = document.getElementById('limitDialog');
var closeBtn = document.getElementById('closeDialog');

closeBtn.addEventListener('click', () => {
    dialog.close();
});

document.addEventListener('change', function (e) {
    if (e.target && e.target.matches('td.boys-cell input[type="checkbox"], td.girls-cell input[type="checkbox"]')) {
    	var cell = e.target.closest('td.boys-cell, td.girls-cell');
        if (!cell) return;

        var checkboxes = Array.from(cell.querySelectorAll('input[type="checkbox"]'));
        var checkedCount = checkboxes.filter(c => c.checked).length;

        if (checkedCount > 3) {
            e.target.checked = false;
            dialog.showModal();  // Show the dialog instead of alert
        }
    }
});


</script>
