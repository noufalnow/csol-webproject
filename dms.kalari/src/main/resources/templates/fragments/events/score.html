<div class="container-fluid">
	<!-- Modal Header -->
	<div class="modal-header">
		<h5 class="modal-title" id="addEventModalLabel" th:text="${pageTitle}">Score
			Card</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal"
			aria-label="Close"></button>
	</div>

	<!-- Modal Body -->
	<div class="modal-body">

		<!-- Filter Section -->
		<div class="card shadow-sm border-0 mb-4 no-print" id="filter_section">
			<form id="search-form" method="GET"
				th:action="@{/champ_participants_score/{eventId}(eventId=${eventId})}">
				<div class="row g-1 align-items-end">
					<!-- Item filter -->
					<div class="col-12 col-md-4">
						<label class="form-label">Item</label> <select name="itemId"
							class="form-select">
							<option value="">-- Select Item --</option>
							<option th:each="entry : ${itemsMap}" th:value="${entry.key}"
								th:text="${entry.value}"
								th:selected="${paramx['itemId']} == ${entry.key.toString()}"></option>
						</select>
					</div>

					<!-- Gender filter -->
					<div class="col-12 col-md-4">
						<label class="form-label">Gender</label> <select name="gender"
							class="form-select">
							<option value="">-- Select Gender --</option>
							<option th:each="g : ${genders}" th:value="${g}" th:text="${g}"
								th:selected="${paramx['gender']} == ${g.name()}"></option>
						</select>
					</div>

					<!-- Category filter -->
					<div class="col-12 col-md-4">
						<label class="form-label">Category</label> <select name="category"
							class="form-select">
							<option value="">-- Select Category --</option>
							<option th:each="c : ${categories}" th:value="${c}"
								th:text="${c}"
								th:selected="${paramx['category']} == ${c.name()}"></option>
						</select>
					</div>

					<!-- Action buttons -->
					<div class="col-12">
						<div
							class="d-flex flex-column flex-md-row gap-2 justify-content-end">
							<!--<button type=button  onclick="searchRequest('search-form')" class="btn btn-sm btn-outline-primary btn-sm">
									<i class="fas fa-search me-1"></i> Search
								</button>
								  <button type="button" class="btn btn-secondary btn-sm"
									onclick="showAll()">
									<i class="fas fa-list me-1"></i> Show All
								</button>-->
						</div>
					</div>
				</div>
			</form>
		</div>



		<!-- Main Content -->
		<form
			th:action="@{/champ_participants_score/{eventId}(eventId=${eventId})}"
			method="post" id="scoreGradeform">
			<input type="hidden" th:name="${_csrf.parameterName}"
				th:value="${_csrf.token}" />

			<div th:if="${matrix == null or #maps.isEmpty(matrix)}">
				<div class="alert alert-info">No items found.</div>
			</div>


			<div th:each="itemEntry : ${matrix}">
				<div class="item-heading">
					<i class="fas fa-trophy me-2"></i>Item: <span
						th:text="${itemEntry.key}"></span>
				</div>

				<div th:each="genderEntry : ${itemEntry.value}">
					<div class="gender-heading" th:text="${genderEntry.key}"></div>

					<div th:each="catEntry : ${genderEntry.value}"
						class="category-section">
						<div class="category-heading">
							<i class="fas fa-tag me-2"></i>Category: <span
								th:text="${catEntry.key}"></span>
						</div>

						<div th:each="mei : ${catEntry.value}" class="participant-card">
							<div class="row g-3 align-items-center">

								<!-- Participant Name -->
								<div class="col-12 col-sm-6 col-md-3">
									<label class="form-label">Participant</label>
									<div class="fw-bold text-primary"
										th:text="${mei.memberEventMember.userFname}"></div>
								</div>

								<!-- Kalari -->
								<div class="col-12 col-sm-6 col-md-3">
									<label class="form-label">Kalari</label>
									<div th:text="${mei.memberEventNode.nodeName}"></div>
								</div>

								<!-- Score & Grade -->
								<div class="col-12 col-sm-6 col-md-6"
									style="padding-left: 1rem;">
									<label class="form-label d-block mb-1">Score & Grade</label>

									<!-- Case 1: Certificate GENERATED -->
									<div th:if="${mei.certificateStatus?.name() == 'GENERATED'}">
										<div class="d-flex align-items-center gap-3">
											<span class="fw-bold" th:text="${mei.memberEventScore}">0.00</span>
											<span th:text="${mei.memberEventGrade?.name()}">Grade</span>
											<a th:href="@{'/files/certificate/' + ${xorMaskHelper.mask(mei.meiId)}}"
												download class="badge bg-warning align-items-center"> <i
												class="fas fa-download me-1"></i> Download
											</a>
										</div>
									</div>

									<!-- Case 2: APPROVED but not GENERATED -->
									<div
										th:if="${mei.verificationStatus?.name() == 'APPROVED' and mei.certificateStatus?.name() != 'GENERATED'}">
										<div class="d-flex align-items-center gap-3">
											<span class="fw-bold" th:text="${mei.memberEventScore}">0.00</span>
											<span th:text="${mei.memberEventGrade?.name()}">Grade</span>
											<span class="badge bg-success">Approved</span>
										</div>
									</div>

									<!-- Case 3: Editable input -->
									<div th:if="${mei.verificationStatus?.name() != 'APPROVED'}"
										class="d-flex align-items-center gap-2">
										<!-- Score -->
										<input type="text" class="form-control"
											th:name="${'scores[' + mei.meiId + ']'}"
											th:value="${mei.memberEventScore}" pattern="^\d*\.?\d*$"
											inputmode="decimal" placeholder="0.00"
											oninput="validateScore(this)" style="max-width: 90px;" />

										<!-- Grade -->
										<select class="form-select flex-fill"
											th:name="${'grades[' + mei.meiId + ']'}"
											style="padding-left: 1rem;">
											<option value="">-- Select Grade --</option>
											<option
												th:each="g : ${T(com.dms.kalari.events.entity.MemberEventItem.Grade).values()}"
												th:value="${g.name()}" th:text="${g.name()}"
												th:selected="${(mei.memberEventGrade != null and mei.memberEventGrade.name() == g.name())}">
											</option>
										</select>
									</div>

								</div>

							</div>
						</div>

					</div>
				</div>
			</div>

			<div id="error-messages" class="text-danger mt-2"></div>
		</form>
	</div>

	<!-- Modal Footer -->
	<div class="modal-footer">
		<button type="button" class="btn btn-secondary"
			data-bs-dismiss="modal">Close</button>
		<button type="button" class="btn btn-primary"
			onclick="submitHtmlForm('scoreGradeform')">Update Score</button>
	</div>
</div>

<script>
        function validateScore(input) {
            let value = input.value;
            
            // Remove any non-digit or non-dot characters
            value = value.replace(/[^0-9.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limit decimal places to 2
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            input.value = value;
            
            // Visual feedback
            if (value === '' || /^\d*\.?\d*$/.test(value)) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
            }
        }

        // Show all participants
        function showAll() {
        	var form = document.getElementById('search-form');
        	var url = form.getAttribute('action'); // <-- use getAttribute
        	form.querySelectorAll('select').forEach(select => {
        	    select.value = ''; // reset all selects
        	});
            loadContent(url,'modal2',form);;
        }

    </script>

<script>
    

    function searchRequest(formId) {
        var form = $('#' + formId); // jQuery form object
        var url = form.attr('action'); // action with eventId/nodeId

        // get selected values
        var itemVal = form.find('select[name="itemId"]').val();
        var genderVal = form.find('select[name="gender"]').val();
        var categoryVal = form.find('select[name="category"]').val();

        console.log("Item:", itemVal, "Gender:", genderVal, "Category:", categoryVal);

        // validate: all must be non-empty
        if (itemVal && genderVal && categoryVal) {
            loadContent(url, 'modal2', form); 
        } 
    }
    
    
    $(document).ready(function() {
        // call searchRequest whenever any select changes
        $('#search-form select').on('change', function() {
            searchRequest('search-form');
        });

        // optional: call it once on page load if selects have values
        // searchRequest('search-form');
    });

    
</script>


