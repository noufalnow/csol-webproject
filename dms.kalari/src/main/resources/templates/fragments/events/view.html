<div class="container-fluid">
    <!-- Modal Header -->
    <div class="modal-header">
        <h5 class="modal-title" id="editEventModalLabel" th:text="${pageTitle}">Edit Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">

<div class="card mb-3 border-secondary shadow-sm">
    <div class="card-body p-3">
        <h6 class="fw-bold text-secondary">Event Information</h6>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label fw-semibold">Event Name</label>
                <div class="form-control-plaintext" th:text="${event.eventName}"></div>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label fw-semibold">Event Date</label>
                <div class="form-control-plaintext"
                     th:text="${#temporals.format(event.eventPeriodStart, 'dd-MM-yyyy')} + ' to ' + ${#temporals.format(event.eventPeriodEnd, 'dd-MM-yyyy')}"></div>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label fw-semibold">Venue</label>
                <div class="form-control-plaintext" th:text="${event.eventVenue}"></div>
            </div>
        </div>
    </div>
</div>

<!-- Category & Badges Card -->
<div class="card mb-3 border-secondary shadow-sm">
    <div class="card-body p-3">
        <!-- Category Tabs -->
        <ul class="nav nav-tabs mb-3" id="categoryTabs" role="tablist">
            <li class="nav-item" role="presentation" th:each="cat, iterStat : ${categories}">
                <button class="nav-link"
                        th:classappend="${iterStat.index == 0} ? 'active'"
                        th:id="${cat.name().toLowerCase()} + '-tab'" data-bs-toggle="tab"
                        th:data-bs-target="'#' + ${cat.name().toLowerCase()} + '-view'"
                        type="button" role="tab"
                        th:aria-controls="${cat.name().toLowerCase()} + '-view'"
                        th:aria-selected="${iterStat.index == 0}"
                        th:text="${#strings.capitalize(cat.name().toLowerCase().replace('_',' '))}">
                </button>
            </li>
        </ul>

        <div class="tab-content" id="categoryTabsContent">
            <!-- Category content with gender tabs and badges -->
            <div class="tab-pane fade" th:each="cat, iterStat : ${categories}"
                 th:classappend="${iterStat.index == 0} ? 'show active'"
                 th:id="${cat.name().toLowerCase()} + '-view'" role="tabpanel"
                 th:aria-labelledby="${cat.name().toLowerCase()} + '-tab'">

                <!-- Gender Tabs -->
                <ul class="nav nav-pills mb-3 justify-content-end gap-2" role="tablist">
                    <li class="nav-item" role="presentation" th:each="gender, gIter : ${genders}">
                        <button class="nav-link btn-sm"
                                th:classappend="${gIter.index == 0} ? 'active'"
                                th:id="${cat.name().toLowerCase()} + '-' + ${gender.name().toLowerCase()} + '-tab'"
                                data-bs-toggle="tab"
                                th:data-bs-target="'#' + ${cat.name().toLowerCase()} + '-' + ${gender.name().toLowerCase()}"
                                type="button" role="tab"
                                th:aria-controls="${cat.name().toLowerCase()} + '-' + ${gender.name().toLowerCase()}"
                                th:aria-selected="${gIter.index == 0}"
                                th:text="${#strings.capitalize(gender.name().toLowerCase())}">
                        </button>
                    </li>
                </ul>

                <!-- Gender Tab Content -->
                <div class="tab-content">
                    <div class="tab-pane fade" th:each="gender, gIter : ${genders}"
                         th:classappend="${gIter.index == 0} ? 'show active'"
                         th:id="${cat.name().toLowerCase()} + '-' + ${gender.name().toLowerCase()}"
                         role="tabpanel">

                        <div class="badge-container">
                            <div th:each="item : ${eventItems}"
                                 th:if="${(cat.name() == 'SENIOR' and #lists.contains(seniorItemIds, item.evitemId)) or
                                         (cat.name() == 'JUNIOR' and #lists.contains(juniorItemIds, item.evitemId)) or
                                         (cat.name() == 'SUBJUNIOR' and #lists.contains(subjuniorItemIds, item.evitemId))}">
                                <span class="badge"
                                      th:classappend="${gender.name() == 'MALE'} ? 'badge-male' : 'badge-female'"
                                      th:text="${item.evitemName}" th:data-category="${cat.name()}"
                                      th:data-gender="${gender.name()}"
                                      th:data-itemid="${item.evitemId}"
                                      onclick="showParticipantsFromBadge(this)"> </span>
                            </div>

                            <div class="text-muted fst-italic"
                                 th:if="${#lists.isEmpty(eventItems)}">
                                No <span th:text="${gender.name().toLowerCase()}"></span> items
                                in <span th:text="${cat.name().toLowerCase().replace('_',' ')}"></span>
                                category.
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<!-- Action Buttons Card -->
<div class="card mb-3 border-secondary shadow-sm">
    <div class="card-body p-3 d-flex flex-wrap gap-2 justify-content-start">

<!-- ðŸŸ© Score Card Button -->
<a th:if="${#authorization.expression('hasAuthority(''PRIV_champ_certificate_approve'')')}"
   class="btn btn-primary btn-sm d-flex align-items-center justify-content-center px-2 py-1"
   th:onclick="'handleButtonAction(\'/champ_participants_score\', ' + ${xorMaskHelper.mask(event.eventId)} + ')'">
    <i class="fas fa-chart-line fa-sm me-1"></i>
    <span>Score Card</span>
</a>

<!-- ðŸŸ¢ Verify & Approve Button -->
<a th:if="${#authorization.expression('hasAuthority(''PRIV_champ_certificate_approve'')')}"
   class="btn btn-success btn-sm d-flex align-items-center justify-content-center px-2 py-1"
   th:onclick="'handleButtonAction(\'/champ_certificate_approve\', ' + ${xorMaskHelper.mask(event.eventId)} + ')'">
    <i class="fas fa-check-double fa-sm me-1"></i>
    <span>Verify &amp; Approve</span>
</a>


        <a th:if="${#authorization.expression('hasAuthority(''PRIV_champ_certificate_generate'')')}"
           class="btn btn-sm btn-primary d-flex align-items-center justify-content-center px-2 py-1"
           th:onclick="'confirmCertificateGeneration(' + '\'' + ${xorMaskHelper.mask(event.eventId)} + '\'' + ')'"
           href="javascript:void(0)">
            <i class="fas fa-certificate fa-sm me-1"></i> <span>Generate Certificates</span>
        </a>

        <button type="button" class="btn btn-info btn-sm text-white" id="btnEmailCertificates">
            <i class="fas fa-envelope fa-sm me-1"></i> Email All Certificates
        </button>

        <button type="button" class="btn btn-danger btn-sm" id="btnMarkEventEnd">
            <i class="fas fa-flag-checkered fa-sm me-1"></i> Mark Event End
        </button>

    </div>
</div>


    </div>

    <!-- Footer -->
    <div class="modal-footer d-flex flex-wrap ">
        <div>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
    </div>

</div>

<!-- ===================== JS ===================== -->
<script>
    function confirmCertificateGeneration(maskedEventId) {
        Swal.fire({
            title: 'Generate Certificates?',
            html: `<p class="text-start">
                    Certificate generation is an <b>irreversible process</b>.<br>
                    Once certificates are generated, you <b>cannot modify</b> the scores or medal grades.
                   </p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Generate',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            allowOutsideClick: false,
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                loadContent(`champ_certificate_generate/${maskedEventId}`, 'modal');
            }
        });
    }

    function showParticipantsFromBadge(element) {

    	
        document.querySelectorAll('.badge.active').forEach(b => b.classList.remove('active'));

        // Add "active" to the clicked one
        element.classList.add('active');
    	
        const category = element.dataset.category;
        const gender = element.dataset.gender;
        const itemId = element.dataset.itemid;
        //loadContent(`/participants/${category}/${gender}/${itemId}`, 'modal');
    }
    
    function handleButtonAction(url, eventId) {
        // Base URL
        let baseUrl = `${url}/${eventId}`;

        // Find the active badge (if any)
        const activeBadge = document.querySelector('.badge.active');

        if (activeBadge) {
            // Read data attributes
            const category = activeBadge.dataset.category;
            const gender = activeBadge.dataset.gender;
            const itemId = activeBadge.dataset.itemid;

            // Append as query parameters
            baseUrl += `?itemId=${encodeURIComponent(itemId)}&gender=${encodeURIComponent(gender)}&category=${encodeURIComponent(category)}`;
        }

        console.log("Final URL:", baseUrl);

        // Load into modal2
        loadContent(baseUrl, 'modal2');
    }

    
   
    
</script>

<!-- ===================== CSS ===================== -->
<style>
    .badge-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        max-height: 280px;
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        background-color: #fafafa;
    }

    .badge {
        font-size: 0.9rem;
        padding: 0.5em 0.75em;
        border-radius: 0.2rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    /* Gender-based colors */
    .badge-male {
        background-color: #0d6efd; /* Bootstrap primary */
        color: #ffffff;
    }

    .badge-female {
        background-color: #e83e8c; /* Pinkish */
        color: #ffffff;
    }
    
    .badge.active {
		background-color: chartreuse;
    	transform: scale(1.05);
	}
	
	.badge-male.active {
    	color: #0a58ca; /* Darker blue */
	}

	.badge-female.active {
    	color: #d63384; /* Darker pink */
	}


    

    /* Active male tab */
    .nav-pills .nav-link.active#senior-male-tab,
    .nav-pills .nav-link.active#junior-male-tab,
    .nav-pills .nav-link.active#subjunior-male-tab {
        background-color: #0d6efd !important;
        color: #fff;
    }

    /* Active female tab */
    .nav-pills .nav-link.active#senior-female-tab,
    .nav-pills .nav-link.active#junior-female-tab,
    .nav-pills .nav-link.active#subjunior-female-tab {
        background-color: #e83e8c !important;
        color: #fff;
    }

    /* ===================== MOBILE RESPONSIVE ===================== */
    @media (max-width: 768px) {
        .nav-tabs, .nav-pills {
            overflow-x: auto;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .nav-tabs .nav-item,
        .nav-pills .nav-item {
            flex: 0 0 auto;
        }

        .badge-container {
            max-height: 180px;
            padding: 0.25rem;
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.35em 0.5em;
        }
    }

    @media (max-width: 576px) {
        .d-flex.flex-wrap.gap-2 > a,
        .d-flex.flex-wrap.gap-2 > button {
            flex: 1 1 100%;
            text-align: center;
        }

        .modal-body {
            padding: 1rem 0.5rem;
        }
    }
    
    .card {
    border-radius: 0.5rem;
}

.card-body {
    padding: 0.75rem;
}
    
</style>
