<style>
/*─── Tree Container & Structure ──────────────────────────────────────────*/
.tree-container {
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.tree-title {
	color: var(--dms-dark);
	margin-bottom: 1.25rem;
	padding-bottom: 0.625rem;
	border-bottom: 2px solid var(--dms-gray-200);
}

.tree {
	list-style: none;
	padding-left: 0.25rem;
}

.tree ul {
	list-style: none;
	padding-left: 1.25rem;
}

.tree li {
	margin: 0.2rem 0;
	position: relative;
}

/*─── Base Tree Node ─────────────────────────────────────────────────────*/
.tree-node {
	display: flex;
	align-items: center;
	padding: 0.25rem 0.625rem;
	border-radius: 0.25rem;
	margin: 0.125rem 0;
	white-space: nowrap;
	transition: all 0.2s ease;
	min-width: min-content;
}

/*─── Node Type-Specific Styling ──────────────────────────────────────────*/
.tree-node.ROOT {
	background-color: rgba(44, 62, 80, 0.15);
	border-left: 3px solid var(--dms-primary);
	font-weight: bold;
}

.toggle-btn, .aspan {
	cursor: pointer;
}

.tree-node.NATIONAL {
	background-color: rgba(52, 73, 94, 0.15);
	border-left: 3px solid var(--dms-secondary);
}

.tree-node.STATE {
	background-color: rgba(241, 196, 15, 0.15);
	border-left: 3px solid var(--dms-warning);
}

.tree-node.DISTRICT {
	background-color: rgba(231, 76, 60, 0.15);
	border-left: 3px solid var(--dms-danger);
}

.tree-node.KALARI {
	background-color: rgba(108, 117, 125, 0.15);
	border-left: 3px solid var(--dms-gray-600);
}

/*─── Interactive States ─────────────────────────────────────────────────*/
.tree-node:hover {
	background-color: var(--dms-gray-100);
}

.tree-node.active {
	/*background-color: var(--dms-accent) !important;
    color: #fff;
    font-weight: bolder;
    position: relative;
    padding-left: 1.5rem;*/
	font-weight: bolder;
	position: relative;
	padding-left: 1.5rem;
	font-family: 'Courgette', cursive;
}

.tree-node.active::before {
	content: "•";
	position: absolute;
	left: 0.5rem;
	font-size: 1.5rem;
	line-height: 1;
	color: green;
}

/*─── Links ───────────────────────────────────────────────────────────────*/
.tree-node>span .aspan {
	color: inherit;
	text-decoration: none;
	flex-grow: 1;
	cursor: pointer;
	pointer-events: auto;
}

.tree-node>span .aspan:hover {
	text-decoration: underline;
}

/*─── Toggle Elements ────────────────────────────────────────────────────*/
.toggle-btn {
	width: 1.5rem;
	height: 1.5rem;
	margin-right: 0.5rem;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	background-color: var(--dms-gray-200);
	border-radius: 0.25rem;
	cursor: pointer;
	font-size: 0.75rem;
	user-select: none;
	transition: background-color 0.2s ease;
	border: 1px solid #bfddfb;
}

.toggle-btn:hover {
	background-color: var(--dms-gray-300);
}

.toggle-btn.closed>span {
	/*transform: rotate(0deg);*/
	transition: transform 0.2s ease;
}

.toggle-btn.open>span {
	/*transform: rotate(90deg);*/
	box-sizing: content-box;
}

.empty-toggle {
	width: 1.5rem;
	margin-right: 0.5rem;
}

/*─── Layout Columns ────────────────────────────────────────────────────*/
.tree-column {
	border: 1px solid var(--dms-gray-300);
	border-radius: 1.25rem;
	padding: 0.125rem;
}

.tree-scroll{
  max-height: none;
  overflow: visible;
}


.content-column {
	border: 2px solid var(--dms-gray-300);
	border-radius: 1.25rem;
	padding: 1.25rem;
}

/*─── Collapsed Branches ─────────────────────────────────────────────────*/
ul.collapsed {
	display: none;
}


@media (max-width: 768px) {

.col-12.col-md-9 {
  padding-right: 1px;
  padding-left: 1px;
}

.content-column {
  padding: 0.25rem;
}
 


  }
</style>



<div class="row mb-3 border-secondary">
	<!-- Left column -->
	<div th:if="not ${#strings.equals(nodeType, 'KALARI')}"
		class="tree-column col-12 col-md-3 mb-2 tree-scroll">
		<div>
			<!-- templates/fragments/node_tree.html -->
			<!-- Main content fragment -->

			<div th:fragment="content">
				<h5 th:text="${pageTitle}" class="tree-title ms-3 mt-3">Node
					Tree</h5>
				<div class="tree-container">
					<ul class="tree">
						<!-- Render the root -->
						<li th:if="${rootNode != null}">
							<div
								th:replace="~{fragments/nodes/node_tree :: nodeItem(
                    node=${rootNode}, 
                    grouped=${groupedTree}, 
                    parentId=${parentId}
                )}"></div>
						</li>
					</ul>
				</div>
			</div>

			<div th:fragment="nodeItem(node, grouped, parentId)">
				<!-- Safely extract values with proper null checking -->



				<th:block
					th:with="
    nodeId = ${node != null ? node.nodeId : null},
    nodeName = ${node != null ? node.nodeName : ''},
    nodeType = ${node != null ? node.nodeType : ''},
    hasChildren = ${grouped != null && nodeId != null && grouped.containsKey(nodeId) && !grouped.get(nodeId).isEmpty()}
">

					<div
						th:class="'tree-node ' + ${nodeType} + (${nodeId != null && nodeId == parentId} ? ' active' : '')"
						th:data-node-id="${nodeId}">

						<!-- Toggle button (only if children exist) -->
						<span th:if="${hasChildren}" class="toggle-btn"> <i
							class="fa fa-folder-open"
							onclick="toggleTreeNode(event, this.closest('.tree-node'))"></i>
						</span> <span th:if="${!hasChildren}" class="empty-toggle"></span>

						<!-- Node label -->
						<span class="aspan" th:text="${nodeName}"
							th:data-node-type="${nodeType}"
							th:data-node-id="${nodeId != null ? xorMaskHelper.mask(nodeId) : ''}"
							th:onclick="${nodeId != null} ? 'onTreeNodeClick(event, this, this.dataset.nodeType)' : null">
							Node Name </span>

					</div>

					<!-- Children list -->
					<ul th:if="${hasChildren}" class="tree-children">
						<li th:each="child : ${grouped.get(nodeId)}">
							<div
								th:replace="~{fragments/nodes/node_tree :: nodeItem(
                node=${child}, 
                grouped=${grouped}, 
                parentId=${parentId}
            )}"></div>
						</li>
					</ul>

				</th:block>





			</div>
		</div>
	</div>
	<!-- Right column -->
	<div class="col-12 col-md-9">
		<div id="users_target" class="content-column"></div>
	</div>

</div>


<script>
  function clearTreeForm() {
    $('#tree_form_target').html('');
  }
  
  // Function to toggle children visibility
function onTreeNodeClick(event, nodeEl, ltype) {

 console.log(ltype);

  activateLink(nodeEl);

  // 3) load content into your target
  const id = nodeEl.getAttribute('data-node-id');
  //loadContent(`/users_bynode/${id}`, '#users_target');
  //loadContent('/events/html/byhost', '#users_target');
  
  const selectedValue = document.querySelector('input[name="choice"]:checked')?.value;
  
  $('#tempSelectedId').val(id);

  if (selectedValue === 'events') {
    loadContent(`/champ_eventbynode/${id}`, '#users_target');
  } 
  else if (selectedValue === 'officials') {
	loadContent(`/officials_bynode/${id}`, '#users_target');
  }
  else if (selectedValue === 'nodes') {
	
	  if(ltype=='KALARI')
		  loadContent(`/officials_bynode/${id}`, '#users_target');
	  
	  else 
	loadContent(`branch_nodelist/${id}`, '#users_target');
	
  } 
  else {

	  if(ltype=='KALARI')
	  
    loadContent(`/members_bynode/${id}`, '#users_target');
	  
	  else
		  
		  loadContent(`/branch_nodelist/${id}`, '#users_target');
  }
  

  

  // 4) clear the form
  clearTreeForm();
}


function toggleTreeNode(event, nodeElement) {
  // find the toggle button container
  const toggleBtn = nodeElement.querySelector('.toggle-btn');
  if (!toggleBtn) return;

  const parentLi   = nodeElement.closest('li');
  const childrenUl = parentLi && parentLi.querySelector('ul');
  if (!childrenUl) return;

  // toggle classes
  childrenUl.classList.toggle('collapsed');
  childrenUl.classList.toggle('expanded');
  toggleBtn.classList.toggle('open');
  toggleBtn.classList.toggle('closed');

  // update +/–
  const icon = toggleBtn.querySelector('i');
  if (icon) {
    icon.classList.toggle('fa-folder-open');
    icon.classList.toggle('fa-folder');
  }

  // stop bubbling
  event.stopPropagation();
}

  
  // Function to activate the clicked link
  function activateLink(link) {
    // Remove active class from all links
    document.querySelectorAll('.tree-node').forEach(node => {
      node.classList.remove('active');
    });
    
    // Add active class to clicked link's parent
    link.closest('.tree-node').classList.add('active');
  }
  
  // Initialize the tree (collapse all except first level)
  document.addEventListener('DOMContentLoaded', function() {
    const allLists = document.querySelectorAll('.tree ul');
    allLists.forEach(list => {
      // Hide all nested lists initially
      if (list.closest('li').querySelector('ul') !== list) {
        list.style.display = 'none';
      }
      
      // Change toggle button to '+' for hidden lists
      const parentNode = list.closest('li');
      if (parentNode) {
        const toggleBtn = parentNode.querySelector('.toggle-btn');
        if (toggleBtn && list.style.display === 'none') {
          toggleBtn.textContent = '+';
        }
      }
    });
    
    // Make nodes with no children have empty toggle space
    document.querySelectorAll('.tree li').forEach(li => {
      if (!li.querySelector('ul')) {
        const emptyToggle = li.querySelector('.empty-toggle');
        if (emptyToggle) {
          emptyToggle.style.visibility = 'hidden';
        }
      }
    });
  });
  
  function getActiveTreeNodeId() {
	    return document.querySelector('.tree-node.active a[data-node-id]')?.getAttribute('data-node-id') || null;
	}
  
  
</script>


<script th:inline="javascript">
    var nodeType = /*[[${nodeType}]]*/ "KALARI";  // fallback string for IDE

    if (nodeType !== 'KALARI') {
        loadContent('branch_nodelist', '#users_target');
    } else {
        loadContent('/members_bynode/', '#users_target');
    }
    
    
    $(document).ready(function() {
        if (SCREEN_WIDTH <= 430) {
            collapseAllNodes();
        }
    });


</script>